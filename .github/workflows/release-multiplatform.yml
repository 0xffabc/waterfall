name: Waterfall on-release build

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag"
        required: false

jobs:
  build:
    name: Build waterfall for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-gnu
            os: ubuntu-latest
            ext: .exe
            cross: true
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            ext: .exe
            cross: false
          - target: i686-pc-windows-msvc
            os: windows-latest
            ext: .exe
            cross: false
          - target: i686-pc-windows-gnu
            os: ubuntu-latest
            ext: .exe
            cross: true
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            ext: .exe
            cross: false
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            ext: ""
            cross: false
          - target: i686-unknown-linux-gnu
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: arm-unknown-linux-gnueabi
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: arm-unknown-linux-gnueabihf
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: armv7-unknown-linux-gnueabihf
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: armv7-unknown-linux-ohos
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: loongarch64-unknown-linux-gnu
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: loongarch64-unknown-linux-musl
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: powerpc-unknown-linux-gnu
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: riscv64gc-unknown-linux-gnu
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: x86_64-unknown-freebsd
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: x86_64-unknown-illumos
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: x86_64-unknown-linux-ohos
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: x86_64-unknown-netbsd
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: x86_64-pc-solaris
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: sparcv9-sun-solaris
            os: ubuntu-latest
            ext: ""
            cross: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Caching
        uses: Swatinem/rust-cache@v2

      - name: Crosscomp
        if: matrix.os == 'ubuntu-latest' && matrix.cross == true
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-mingw-w64-x86-64 \
            gcc-mingw-w64-i686 \
            gcc-arm-linux-gnueabi \
            gcc-arm-linux-gnueabihf \
            gcc-aarch64-linux-gnu \
            gcc-riscv64-linux-gnu \
            gcc-powerpc-linux-gnu \
            gcc-powerpc64-linux-gnu \
            gcc-powerpc64le-linux-gnu \
            gcc-i686-linux-gnu \
            gcc-mips-linux-gnu \
            gcc-mipsel-linux-gnu \
            gcc-mips64-linux-gnuabi64 \
            gcc-mips64el-linux-gnuabi64 \
            gcc-sparc64-linux-gnu \
            gcc-s390x-linux-gnu \
            libc6-dev-armel-cross \
            libc6-dev-armhf-cross \
            libc6-dev-arm64-cross \
            libc6-dev-i386-cross \
            libc6-dev-mips-cross \
            libc6-dev-mipsel-cross \
            libc6-dev-mips64-cross \
            libc6-dev-mips64el-cross \
            libc6-dev-ppc64-cross \
            libc6-dev-ppc64el-cross \
            libc6-dev-riscv64-cross \
            libc6-dev-s390x-cross \
            libc6-dev-sparc64-cross \
            libc6-dev-i386 \
            libc6-dev-amd64-cross \
            linux-libc-dev-mips-cross \
            linux-libc-dev-mipsel-cross \
            linux-libc-dev-mips64-cross \
            linux-libc-dev-armel-cross \
            linux-libc-dev-armhf-cross \
            linux-libc-dev-arm64-cross \
            musl-tools \
            musl-dev \
            llvm-dev \
            libclang-dev \
            clang \
            qemu-user-static \
            binutils-multiarch \
            binfmt-support \
            gcc-multilib \
            g++-multilib \
            libc6-dev-i386 \
            libc6-dev-amd64-i386-cross \
            libc6-dev-i386-amd64-cross \
            freebsd-glue \
            golang-go \
            upx \
            || true

          mkdir -p ~/.cargo
          case "${{ matrix.target }}" in
            *-linux-gnu*)
              echo "[target.${{ matrix.target }}]" >> ~/.cargo/config.toml
              echo "linker = \"${{ matrix.target }}-gcc\"" >> ~/.cargo/config.toml
              ;;
            *-linux-musl*)
              echo "[target.${{ matrix.target }}]" >> ~/.cargo/config.toml
              echo "linker = \"musl-gcc\"" >> ~/.cargo/config.toml
              ;;
            *-freebsd*)
              echo "[target.${{ matrix.target }}]" >> ~/.cargo/config.toml
              echo "linker = \"x86_64-unknown-freebsd12-gcc\"" >> ~/.cargo/config.toml
              ;;
            *-solaris* | *-illumos*)
              echo "[target.${{ matrix.target }}]" >> ~/.cargo/config.toml
              echo "linker = \"gcc\"" >> ~/.cargo/config.toml
              echo "rustflags = [\"-C\", \"link-arg=-Wl,-z,ignore\"]" >> ~/.cargo/config.toml
              ;;
          esac
          if [[ "${{ matrix.target }}" == *"loongarch64"* ]] || \
             [[ "${{ matrix.target }}" == *"sparc"* ]] || \
             [[ "${{ matrix.target }}" == *"ohos"* ]]; then
            cargo install cross
            echo "CROSS_RS=1" >> $GITHUB_ENV
          fi
          echo "CARGO_TARGET_$(echo ${{ matrix.target }} | tr '[:lower:]' '[:upper:]' | tr '-' '_')_LINKER=${{ matrix.target }}-gcc" >> $GITHUB_ENV
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV
          echo "RUSTFLAGS=-C linker=${{ matrix.target }}-gcc" >> $GITHUB_ENV
          if [[ "${{ matrix.target }}" == *"musl"* ]]; then
            echo "RUSTFLAGS=-C target-feature=+crt-static -C linker=musl-gcc" >> $GITHUB_ENV
          fi
      - name: MSVC
        if: matrix.os == 'windows-latest' && contains(matrix.target, 'msvc')
        uses: ilammy/msvc-dev-cmd@v1

      - name: Targets
        run: rustup target add ${{ matrix.target }}

      - name: Release
        run: |
          if [ "$CROSS_RS" = "1" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
        env:
          RUST_BACKTRACE: 1

      - name: Bin copy
        run: |
          mkdir -p dist
          TAG_NAME="${{ github.event.release.tag_name }}"
          if [ -z "$TAG_NAME" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          fi
          if [ -z "$TAG_NAME" ]; then
            TAG_NAME="latest"
          fi
          TARGET_SANITIZED=$(echo "${{ matrix.target }}" | sed 's/-unknown//g' | sed 's/-pc//g' | tr '-' '_')
          if [[ "${{ matrix.target }}" == *"windows"* ]] || [[ "${{ matrix.target }}" == *"msvc"* ]] || [[ "${{ matrix.target }}" == *"gnu"* && "${{ matrix.ext }}" == ".exe" ]]; then
            cp "./target/${{ matrix.target }}/release/waterfall.exe" "./dist/waterfall-${TAG_NAME}-${TARGET_SANITIZED}${{ matrix.ext }}"
          else
            cp "./target/${{ matrix.target }}/release/waterfall" "./dist/waterfall-${TAG_NAME}-${TARGET_SANITIZED}${{ matrix.ext }}"
          fi
        shell: bash

      - name: dist upload
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: waterfall-${{ matrix.target }}
          path: dist/*
          retention-days: 30

  commit-dist:
    name: Commit dist folder
    needs: build
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - name: A
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: B
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: C
        run: |
          mkdir -p dist
          find artifacts -type f -name "waterfall-*" -exec cp {} dist/ \;
      - name: D
        run: |
          tar -cvf waterfall-builds.tar dist
          rm -rf dist/
          git config --local user.email "qulsar@nicemail.i2p"
          git config --local user.name "Qulsar"
          git add waterfall-builds.tar
          git commit -m "Dist update"
          git push
