on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag"
        required: false

jobs:
  build:
    name: Build waterfall for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-gnu
            os: ubuntu-latest
            ext: .exe
            cross: true
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            ext: .exe
            cross: false
          - target: i686-pc-windows-msvc
            os: windows-latest
            ext: .exe
            cross: false
          - target: i686-pc-windows-gnu
            os: ubuntu-latest
            ext: .exe
            cross: true
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            ext: .exe
            cross: false
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            ext: ""
            cross: false
          - target: i686-unknown-linux-gnu
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: arm-unknown-linux-gnueabi
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: arm-unknown-linux-gnueabihf
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: armv7-unknown-linux-gnueabihf
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: armv7-unknown-linux-ohos
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: loongarch64-unknown-linux-gnu
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: loongarch64-unknown-linux-musl
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: powerpc-unknown-linux-gnu
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: riscv64gc-unknown-linux-gnu
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: x86_64-unknown-freebsd
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: x86_64-unknown-illumos
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: x86_64-unknown-linux-ohos
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: x86_64-unknown-netbsd
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: x86_64-pc-solaris
            os: ubuntu-latest
            ext: ""
            cross: true
          - target: sparcv9-sun-solaris
            os: ubuntu-latest
            ext: ""
            cross: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Caching
        uses: Swatinem/rust-cache@v2

      - name: Crosscomp
        if: matrix.os == 'ubuntu-latest' && matrix.cross == true
        run: |
          sudo apt-get update
          for pkg in \
              binutils-multiarch \
              qemu-user-static \
              binfmt-support \
              gcc-aarch64-linux-gnu \
              gcc-arm-linux-gnueabi \
              gcc-arm-linux-gnueabihf \
              gcc-i686-linux-gnu \
              gcc-mips-linux-gnu \
              gcc-mipsel-linux-gnu \
              gcc-mips64-linux-gnuabi64 \
              gcc-powerpc-linux-gnu \
              gcc-riscv64-linux-gnu \
              gcc-s390x-linux-gnu \
              gcc-sparc64-linux-gnu \
              libc6-dev-arm64-cross \
              libc6-dev-armel-cross \
              libc6-dev-armhf-cross \
              libc6-dev-i386-cross \
              libc6-dev-mips-cross \
              libc6-dev-mipsel-cross \
              libc6-dev-mips64-cross \
              libc6-dev-powerpc-cross \
              libc6-dev-ppc64-cross \
              libc6-dev-riscv64-cross \
              libc6-dev-s390x-cross \
              libc6-dev-sparc64-cross \
              gcc-mingw-w64-x86-64 \
              gcc-mingw-w64-i686 \
              freebsd-glue \
              curl \
              libcurl-devel \
              libcurl4-openssl-dev \
              gcc-multilib \
              g++-multilib \
              libc6-dev-i386 \
              libc6-dev-i386-cross \
              linux-libc-dev:i386 \
              gcc-14-loongarch64-linux-gnu \
              binutils-loongarch64-linux-gnu \
              libunwind-dev \
              musl-tools \
              musl-dev \
              cmake \
              ninja-build; do
              sudo apt-get install -y "$pkg" || true
          done

      - name: MSVC
        if: matrix.os == 'windows-latest' && contains(matrix.target, 'msvc')
        uses: ilammy/msvc-dev-cmd@v1

      - name: Targets
        run: rustup target add ${{ matrix.target }}

      - name: Release
        run: cargo build --release --target ${{ matrix.target }}
        env:
          RUST_BACKTRACE: 1

      - name: Bin copy
        run: |
          mkdir -p dist
          TAG_NAME="${{ github.event.release.tag_name }}"
          if [ -z "$TAG_NAME" ]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          fi
          if [ -z "$TAG_NAME" ]; then
            TAG_NAME="latest"
          fi
          TARGET_SANITIZED=$(echo "${{ matrix.target }}" | sed 's/-unknown//g' | sed 's/-pc//g' | tr '-' '_')
          if [[ "${{ matrix.target }}" == *"windows"* ]] || [[ "${{ matrix.target }}" == *"msvc"* ]] || [[ "${{ matrix.target }}" == *"gnu"* && "${{ matrix.ext }}" == ".exe" ]]; then
            cp "./target/${{ matrix.target }}/release/waterfall.exe" "./dist/waterfall-${TAG_NAME}-${TARGET_SANITIZED}${{ matrix.ext }}"
          else
            cp "./target/${{ matrix.target }}/release/waterfall" "./dist/waterfall-${TAG_NAME}-${TARGET_SANITIZED}${{ matrix.ext }}"
          fi
        shell: bash

      - name: dist upload
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: waterfall-${{ matrix.target }}
          path: dist/*
          retention-days: 30

  commit-dist:
    name: Commit dist folder
    needs: build
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - name: A
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: B
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: C
        run: |
          mkdir -p dist
          find artifacts -type f -name "waterfall-*" -exec cp {} dist/ \;
      - name: D
        run: |
          tar -cvf waterfall-builds.tar dist
          rm -rf dist/
          git config --local user.email "qulsar@nicemail.i2p"
          git config --local user.name "Qulsar Bot"
          git add waterfall-builds.tar
          git commit -m "Dist update"
          git push
