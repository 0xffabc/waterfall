Waterfall
=========

Waterfall's a network traffic modification software written in Rust

The traffic is captured via a SOCKS5 proxy and requires a client that handles direct socket connections properly

Build information
-----------------

* build+run: `cargo run`
* build: `cargo build`

First run will generate a config.xml file, unless you specified the exact filename with `--config`

Limitations
-----------

* No schannel support (tokio merges every TLS record from the server to handle backpressuring, and schannel mandates every record to be sent as a separate segment)
  You should compile curl with OpenSSL instead. Moreover, OpenSSL is a correct ssl implementation.
  You can also consider rustls (if you're on Rust, obviously)
  In future, I'll add a configuration flag to disable async socket piping and use the old multi-threaded approach instead.
* Inability to inject fabricated TCP packets in the stream (libpcap solves that)
* Lack of customization for fake packets RNG
* Inability to choose a Teredo interface on Windows as a fallback for `iface` config option on IPv6
* DNS leak in waterfall-proxy makes DoH/non DoH DNS requests go through the system, and not waterfall-proxy

Most of these limitations are eventually fixable and will be patched over time
However, you can make a PR if you're interested

Essential Info
--------------

examples/ are outdated, use /config.xml instead

* bind-options: iface-mtu, iface-ipv4-ip and iface-ipv6-ip are reserved for TUN support
* fake-packet-options: only-oob marks every fake packet as OOB, could be dropped by the DPI
  - protocol-http simulates an HTTP connection
  - send-reversed would send the fake first
  - send-random-garbage generates a random byte stream and sends it (seed=0xDEAD, add configuration option for RNG later)
  - send-clienthello sends a fake CH with sni=clienthello-sni
  - <send-twice>{bool}</send-twice>, where {bool} decides whether to duplicate the fake or not
* socket-options:
  - desync-cutoff-ms <N> is useful for setting a low initial send/recv buffer. Both buffers would reset to 16kb after N ms.
  - disable-sack works ONLY on linux with BPF filters. We'll need functionality to decompose this in a configuration option
      (something like <BPF code="..." jt="0" jf="8" k="0x00000036" />), therefore disable-sack might get removed
  - oob-hell-data changes what bytes OobStream sends as OOB between separated packets. OobStream CAN and WILL confuse Wireshark's DPI a lot
* http-options:
  - Depends on a sequence of 'http' word in the packet (internal DPI will not modify packets with randomized capsulation or any other tweaks)
* desync-options:
  - packet-hops-max specifies how much packets the internal DPI must process. BufReader hook would return Ok(size) afterwards
  - default-ttl works for disorder packets, currently TSPU checks whether packet-ttl is in range of default-ttl (for disorder),
    so you might not want to set it to 4. Use traceroute/tracert to find where the closest loss-hop is
* dns-options: you might not want to have 'integrated_doh_enabled'='true', since it's known to mess with socks2tun (curl chooses the TUN adapter's interface on wintun impl)
  - use whitelist-sni-list if you don't want to feed internal DPI with every packet possible
* negative_offset for strategies reverses the effect of offset, offset="3" becomes offset="-3" (pseudoarg)

Current limitations: lack of BPF filter config, lack of mod utils/random's seed customization
You might want to use `bpf_asm` to wrie BPF filters after they get considered by the config

Disabling selective acknowledgment
----------------------------------

This is useful for fake packets, since windows acts weird with them, and resends the whole CH at some index.
Please, DON'T use this with disorder group. Consider using jitter socket option instead
It will prevent windows from holding separated packets in the send buffer, even while NO_DELAY option isn't available (for some reason)

Sometimes it's easier to modify the strategy and put a disorder group strategy before the fake packet.
Use SACK disabler as the last resort.

Note: You can't disable SACK on socket level on windows, so you'll have to edit the registry value `SackOpts` in `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters` and set it to DWORD 0

SACK will be disabled for every connection, and not just the ones the proxy makes.

Router rules
------------

Sometimes you might want to forward a part of traffic to a socks5 proxy (or even block it)
Waterfall's internal DPI tries to retrieve SNI (server name indication), IP and Socks5 DNS requests from what it gets
An example rule would block every visible clienthello to gateway.discord.gg

```
<router-options>
  <!-- Prevent discord from connecting to main gateway URL -->

  <rules
    scope="SNI"
    type="Forward"
    match="*.discord.gg"
    exec="block 127.0.0.1:9050"
  />
</router-options>
```

Available router scopes: SNI, DnsQuery, IP (4, 6)
Router rule types: Forward (socks5, block), FakeDNS
* FakeDNS is useful for forwarding a domain to its correct IP (basically, a userland replacement of hosts file). A common case is resolving ntc.party to <pretend that ntc.party's IPv4 is there>

FakeDNS will run before the DOH resolver and bypass it completely, and can be only used with DnsQuery scope.
Forward is not available on SNI, unless it's a `block` type.

Global strategy whitelist
-------------------------

Denoted as

```
<whitelist-sni-list list="domain" value="googlevideo.com" />
```

Where list is WhiteListedSNI (basically domain, file, path)
File and path aren't considered as for now

Strategy config
---------------

```
<strategies
        type="FRAGTLS"
        offset="3"
        add-sni="true"
        add-host="false"
        negative_offset="false"
    >
        <filter-protocol>TCP</filter-protocol>
        <filter-port>
            <start>442</start>
        </filter-port>
        <filter-sni>
            <WhiteListedSNIWrapper list="domain" value="youtube.com" />
            <WhiteListedSNIWrapper list="domain" value="discord.com" />
            <WhiteListedSNIWrapper list="domain" value="discordapp.com" />
            <WhiteListedSNIWrapper list="domain" value="googlevideo.com" />
        </filter-sni>
    </strategies>
```

Available types
* NONE - Noop action
* SPLIT - Segments the packet. Corresponds to geneva's `fragment`
* DISORDER - Segments the packet, sends the first with low TTL
* DISORDER2 - The same as DISORDER, but the second is sent with low TTL instead
* FAKEMD - The same as SPLIT, but we get a fake in between
* FAKE - The same as FAKEMD, but DISORDER is used instead of SPLIT
* FAKE2INSERT - The same as FAKEMD, but ignores most fake options
* FAKE2DISORDER - The same as FAKEMD, but DISORDER2 is used
* FAKESURROUND - SPLIT segments are surrounded with fakes
* MELTDOWN - TTL=1 for the whole packet. In other words, duplicates the remaining part from previous operations. Corresponds to geneva's `duplicate`
* OOB - inserts an OOB byte in between of the segments
* OOBSTREAMHELL - inserts A LOT of OOB bytes
* DISOOB - DISORDER + OOB
* OOB2 - DISORDER2 + OOB
* FRAGTLS - Splits TLS header in two parts, used to be a powerful counter-attack against GFW. For more info: https://upb-syssec.github.io/blog/2023/record-fragmentation/. A particular case of geneva's `tamper`
*

AOB Scanning on packets and replacements
----------------------------------------

Waterfall provides functionality for AOB scanning on every packet processed by client_hook
If you want to use AOB scanning via patterns for the whole connection, adjust your whitelists

A pattern specifies how the internal DPI should detect/replace different bytes in packets
This is useful for replacing server name indication to a different one, if the website provides a SAN certificate
A great example is youtube.com, you can interchange blogger.com and youtube.com for TLS connections
This allows us to bypass the censor

Technical limitations:
  * Patterns aren't a subject for hot-reloading, you'll have to restart waterfall after updating one of them.

A pattern's sizes can differ from each other. In the case when the replacement is smaller, waterfall-proxy will remove the last trailing
elements from the vector
When the replacement is longer, waterfall will shift every other element to the right side

A typical pattern configuration looks like this

    <pattern-options>
        <patterns
            pattern="x7777772E796F75747562652E636F6D"
            replacement="x7777772E626C6F676765722E636F6D"
        />
    </pattern-options>

This pattern replaces every youtube.com string to blogger.com, which allows you
to open youtube on some ISPs. You'll have to configure domain exclusion lists for the domains
that aren't compatible with google's SAN certificate

Typically, the youtube.com page would load just fine (probably because of caching), but it would notify you
about the lack of internet connection

You might want to use patterns for manual TLS fragmentation and JA3 fingerprint modification.

Always remember that the servers without a SAN certificate wouldn't accept a miscellaneous SNI.

Where any [AA] is a valid uppercase hex integer, and x is an unknown variable
Formally, waterfall will skip every byte if it sees the b'x' token in any of the patterns
Pattern lexer/compiler will panic before starting the SOCKS5 proxy in these cases:
* The pattern's length is less than 2
* A hex integer is being finished at an index of 0
* Hex integer group out of previous and current byte is not a valid ASCII string
* The ASCII string is not a valid hex
* The lexer saw the b'x' token when expecting a last digit of hex
* The lexer saw an unknown token
* The lexer didn't process the pattern completely

In an event of an error, the lexer will stop the whole program and print an error message.

Getting waterfall to work on nekoray/socks2tun
----------------------------------------------

Nekoray support is highly experimental as for now and requires a lot of manual configuration
Let's say, you're using nekoray, which allows you to specify CIDR/process bypass for TUN mode

Firstly, run ifconfig/ipconfig to check which interface/adapter is used for the network
For me, that would be `wlan0`. If you're on windows, it would look like something of 'Ethernet'.

Set the target interface (`iface` field) to the device name in your configuration:

```
<bind-options
        host="192.168.1.101"
        port="14768"
        iface="Ethernet"
        iface-mtu="1500"
        iface-ipv4-ip="0.0.0.0"
        iface-ipv6-ip="::"
    />
```

As previously mentioned, iface-mtu|iface-ip*-ip are currently reserved, so don't touch them.
After that, you must configure your proxy client to not capture waterfall-proxy's socket connections.
It's practically known that socket2-ext's bind_device dies to wintun's capture intention
Therefore, you'll have to setup CIDR ranges on your local network, and for extra safety, process names
for me, the only CIDR would be 172.16.0.0/12, and the process would be 'waterfall'
On Windows, I also had to use 192.168.0.1/24 and svchost (otherwise, every packet fell into neko-tun queue)
If you're unsure, use wireshark to check which CIDRs you need to exclude in the proxy client configuration.

DNS multiplexer
---------------

Waterfall-proxy will try to resolve every domain using DoH by default.
This makes it harder to censor or watch which websites you're visiting, since DNS queries are encrypted.
DNS multiplexer can be disabled (but is is NOT recommended) with `integrated_doh_enabled` configurator option.

Typically, a DNS multiplexer config looks like this:

```
    <dns-options integrated_doh_enabled="true">
        <doh-servers url="https://cloudflare-dns.com/dns-query?dns={}" />
        <doh-servers
            url="https://mozilla.cloudflare-dns.com/dns-query?dns={}"
        />
        <doh-servers url="https://dns.google/dns-query?dns={}" />
        <doh-servers url="https://dns.quad9.net/dns-query?dns={}" />
        <doh-servers url="https://freedns.controld.com/p0?dns={}" />
    </dns-options>
```

Where {} is the field for replacement of the DNS query, for spec-incompilant resolvers
Having multiple resolvers is always better, since one of them could just stop working
due to your ISP or different causes.

Note that the OS would still resolve the domains of your DNS servers. I'm looking forward to
fixing this issue by forcing them to go through waterfall-proxy.

UDP support
-----------

Waterfall-proxy uses 3 tasks per each connection

* Shutdown controller
* UDP piper (includes a relay/flow manager to remove dangling FDs)
* Garbage collector (works every 60secs)

UDP tasks will be progressively finished as the connection closed/an error happened

Implementation details
----------------------

* Router uses DNS-resolved IP and the SOCKS5 request domain for RouterRuleType::SNI as for now
* IPv6-enabled interfaces aren't handled by the socket binder, if you use one, fall back to `default`
* SNI, IP router scopes are handled before the socket creation, to allow FORWARD router rule
* Fakedns action type makes sense only with the DnsQuery router scope
* Router will use the first rule available for current context and ignore every other one
* Waterfall is currently fully async

Planned features
----------------

- BPF filter config (<BPFilters>, <BPF />)
- Config verification
- Eventually waterfall will become a more advanced traffic inspection and modification tool, rather than just a censorship evasion tool
- Eventually waterfall will become an autonomous censorship evasion tool
- A more advanced packet injection config

Useful sources
--------------

https://geneva.cs.umd.edu/papers/geneva_ccs19.pdf - Waterfall inherits geneva's strategy branching
https://upb-syssec.github.io/blog/2023/record-fragmentation/ - FRAGTLS
https://github.com/hufrea/byedpi - Significantly shaped my views on how a DPI bypass would look like
